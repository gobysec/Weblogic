# Analysis of Weblogic CVE-2021-2394 Deserialization Vulnerability

> Author: Kejaly from the WhiteHat Alliance Security Research Institute

> Proofreader: R4v3zn from the WhiteHat Alliance Security Research Institute



# 0x00 Introduction

On July 21, 2021, Oracle released a series of security updates, involving 342 vulnerabilities in its products, including Weblogic Server, Database Server, Java SE, MySQL, etc. (https://www.oracle.com/security-alerts/cpujul2021.htm). Among them, there is a high-risk vulnerability in the Oracle WebLogic Server product, with the vulnerability number CVE-2021-2394 and a CVSS score of 9.8. It affects multiple versions of WebLogic and can be exploited remotely with low difficulty using the T3 and IIOP protocols.

![image.png](https://nosec.org/avatar/uploads/attach/image/588d7107136814b2d28592ee41997d0f/image.png)

After analysis, this vulnerability combines the deserialization chains of CVE-2020-14756 and CVE-2020-14825, and uses the class FilterExtractor to bypass the patch released in April.



# 0x01 Exploitation

This vulnerability is mainly due to the fact that the `FilterExtractor`'s `readExternal` method will directly create a `MethodAttributeAccessor` object, bypassing the patch released in April by avoiding blacklists.

The `FilterExtractor` class has the following characteristics:

1. `FilterExtractor` implements the `ExternalizableLite` interface and overrides the `readExternal` method:

![image.png](https://nosec.org/avatar/uploads/attach/image/a5ec815429e7047b19abc24d5454bfe1/image.png)
![image.png](https://nosec.org/avatar/uploads/attach/image/92e35044fa1fdc5c886fbbfd64a6e034/image.png)

`readExternal`will call the `oracle.eclipselink.coherence.integrated.internal.cache.Serialization helper#readAttributeAccessor` method:

![image.png](https://nosec.org/avatar/uploads/attach/image/a3347494d9c310870b65ff908562703d/image.png)

It can be seen that a `MethodAttributeAccessor` object will be created, and its `setAttributeName`, `setGetMethodName`, and `setSetMethodName` properties will be assigned based on the `DataInput` (which means that these three attributes are controllable). 

2. The `extract` method of `FilterExtractor` contains a call to `this.attributeAccessor.getAttributeValueFromobject()`.

![image.png](https://nosec.org/avatar/uploads/attach/image/857dfc573931c0eece14ebebd2b15ec4/image.png)

Friends familiar with vulnerabilities in the `coherence` component should know that in CVE-2020-14825, `MethodAttributeAccessor.getAttributeValueFromobject()` was used to call arbitrary parameterless methods.

[![p9MKzb8.jpg](https://s1.ax1x.com/2023/04/26/p9MKzb8.jpg)](https://imgse.com/i/p9MKzb8)

Although `MethodAttributeAccessor` has been added to the blacklist, in the mentioned `readExternal` method, a `MethodAttributeAccessor` object is directly created, which means that the object is not obtained through deserialization and is naturally not affected by the blacklist.



### Call Chain

The complete call chain is as follows:

![image.png](https://nosec.org/avatar/uploads/attach/image/e617a121ece464acfdf3cc03a851ad09/image.png)

![image.png](https://nosec.org/avatar/uploads/attach/image/430b714a576dfa37ba861582d2d71db8/image.png)

### Successful RCE:

![image.png](https://nosec.org/avatar/uploads/attach/image/578d59954737bfa4d72e8c7f333c8699/image.png)

### 10.3.6.0 issue

![image.png](https://nosec.org/avatar/uploads/attach/image/4caebc31550469e980d6f63d23091626/image.png)

When attempting to reproduce the poc based on `TopNAggregator.PartialResult` against the version mentioned on the official website, it was discovered that the `com.tangosol.util.SortedBag` and `com.tangosol.util.aggregator.TopNAggregator` classes do not exist in version 10.3.6.0.0:

![image.png](https://nosec.org/avatar/uploads/attach/image/e4f3d61c9e11e48ab2f2a6d93114553d/image.png)

Missing `SortedBag`:

![image.png](https://nosec.org/avatar/uploads/attach/image/ac40e7e7ea83480f0d4c91a63148ac3a/image.png)

Missing `TopNAggregator`:

![image.png](https://nosec.org/avatar/uploads/attach/image/14f575f596621bdae815465594e50bbb/image.png)

### WebLogic version issue

After conducting tests using jar files of different versions against different versions of WebLogic, the following findings were discovered:

| Jar Version | WebLogic Version | Success |
| :---------- | :--------------- | :------ |
| 12.1.3.0.0  | 12.1.3.0.0       | Success |
| 12.1.3.0.0  | 12.2.1.3.0       | Failure |
| 12.1.3.0.0  | 12.2.1.4.0       | Failure |
| 12.1.3.0.0  | 14.1.1.0.0       | Failure |
| 12.2.1.3.0  | 12.1.3.0.0       | Failure |
| 12.2.1.3.0  | 12.2.1.3.0       | Success |
| 12.2.1.3.0  | 12.2.1.4.0       | Success |
| 12.2.1.3.0  | 14.1.1.0.0       | Success |
| 12.2.1.4.0  | 12.1.3.0.0       | Failure |
| 12.2.1.4.0  | 12.2.1.3.0       | Success |
| 12.2.1.4.0  | 12.2.1.4.0       | Success |
| 12.2.1.4.0  | 14.1.1.0.0       | Success |
| 14.1.1.0.0  | 12.1.3.0.0       | Failure |
| 14.1.1.0.0  | 12.2.1.3.0       | Success |
| 14.1.1.0.0  | 12.2.1.4.0       | Success |

## General Patch Recommendation

Oracle has released patches, and it is recommended to update in a timely manner: https://www.oracle.com/security-alerts/cpujul2021.html

## Weblogic Temporary Patch Recommendation

1. If JVM communication does not depend on the T3 protocol, it is recommended to disable it.
2. If JVM communication does not depend on the IIOP protocol, it is recommended to disable it.

## References

https://www.cnblogs.com/potatsoSec/p/15062094.html

https://mp.weixin.qq.com/s/LbMB-2Qyrh3Lrqc_vsKIdA


<br/>

<br/>
[Goby Official URL](https://gobies.org/)

If you have a functional type of issue, you can raise an issue on GitHub or in the discussion group below:

1. GitHub issue: https://github.com/gobysec/Goby/issues
2. Telegram Group: http://t.me/gobies (Community advantage: Stay updated with the latest information about Goby features, events, and other announcements in real-time.) 
3. Telegram Channel: https://t.me/joinchat/ENkApMqOonRhZjFl 
4. Twitterï¼š[https://twitter.com/GobySec](https://twitter.com/GobySec)
