# Weblogic CVE-2021-2394反序列化漏洞分析

作者：白帽汇安全研究院@kejaly

校对：白帽汇安全研究院@r4v3zn

# 0x00 前言

在2021年7月21日，Oracle官方发布了一系列安全更新。涉及旗下产品（Weblogic Server、Database Server、Java SE、MySQL等）的 342 个漏洞，https://www.oracle.com/security-alerts/cpujul2021.htm。其中，Oracle WebLogic Server 产品中有高危漏洞，漏洞编号为 CVE-2021-2394，CVSS 评分9.8分，影响多个 WebLogic 版本，且漏洞利用难度低，可基于 T3 和 IIOP 协议执行远程代码。

![image.png](https://nosec.org/avatar/uploads/attach/image/588d7107136814b2d28592ee41997d0f/image.png)

经过分析，此次漏洞结合了 CVE-2020-14756 和 CVE-2020-14825 反序列化链，利用`FilterExtractor` 这个类来对4月份补丁进行绕过。

# 0x01 漏洞利用

该漏洞主要是因为 `FilterExtractor` 的 `readExternal` 方法中会直接 `new` 一个 `MethodAttributeAccessor` 对象，使得生成 `MethodAttributeAccessor`的时候不会受到黑名单的限制，来对4月份的补丁进行绕过。

`FilterExtractor` 类具有如下特征：

1.`FilterExtractor` 实现了 `ExternalizableLite` 接口，重写了 `readExternal` 方法：

![image.png](https://nosec.org/avatar/uploads/attach/image/a5ec815429e7047b19abc24d5454bfe1/image.png)
![image.png](https://nosec.org/avatar/uploads/attach/image/92e35044fa1fdc5c886fbbfd64a6e034/image.png)

`readExternal` 会调用`oracle.eclipselink.coherence.integrated.internal.cache.Serialization helper#readAttributeAccessor` 方法:

![image.png](https://nosec.org/avatar/uploads/attach/image/a3347494d9c310870b65ff908562703d/image.png)

可以看到会 `new` 一个 `MethodAttributeAccessor` 对象，然后根据 `DataInput` 赋值它的 `setAttributeName`，`setGetMethodName` 以及 `setSetMethodName` 属性（这就导致这三个属性是可控的）。

2.`FilterExtractor` 的 `extract` 方法中存在 `this.attributeAccessor.getAttributeValueFromobject()` 的调用。

![image.png](https://nosec.org/avatar/uploads/attach/image/857dfc573931c0eece14ebebd2b15ec4/image.png)

熟悉 coherence 组件的漏洞的朋友应该知道在 CVE-2020-14825 中，就是利用 `MethodAttributeAccessor.getAttributeValueFromobject()` 来实现任意无参方法的调用的。

[![p9MKzb8.jpg](https://s1.ax1x.com/2023/04/26/p9MKzb8.jpg)](https://imgse.com/i/p9MKzb8)

虽然 `MethodAttributeAccessor` 已经加入到了黑名单，但是在上面提到的 `readExternal` 方法中恰好直接 `new` 了一个 `MethodAttributeAccessor` 对象，也就是说不是通过反序列化得到 `MethodAttributeAccessor` 对象，自然也就不受黑名单的影响。

## 2.1 调用链

完整调用链如下：

![image.png](https://nosec.org/avatar/uploads/attach/image/e617a121ece464acfdf3cc03a851ad09/image.png)

![image.png](https://nosec.org/avatar/uploads/attach/image/430b714a576dfa37ba861582d2d71db8/image.png)

成功 RCE：

![image.png](https://nosec.org/avatar/uploads/attach/image/578d59954737bfa4d72e8c7f333c8699/image.png)



## 2.2 10.3.6.0 问题

![image.png](https://nosec.org/avatar/uploads/attach/image/4caebc31550469e980d6f63d23091626/image.png)

在使用基于 `TopNAggregator.PartialResult` 的 poc 对官网说的版本进行复现的时候，发现 10.3.6.0.0 版本中并不存在 `com.tangosol.util.SortedBag` 和 `com.tangosol.util.aggregator.TopNAggregator` 这两个类：

![image.png](https://nosec.org/avatar/uploads/attach/image/e4f3d61c9e11e48ab2f2a6d93114553d/image.png)

缺少 `SortedBag`：

![image.png](https://nosec.org/avatar/uploads/attach/image/ac40e7e7ea83480f0d4c91a63148ac3a/image.png)

缺少 TopNAggregator :

![image.png](https://nosec.org/avatar/uploads/attach/image/14f575f596621bdae815465594e50bbb/image.png)


## 2.3 weblogic 版本问题

使用不同 weblogic 版本的 jar 包对不同版本的 weblogic 进行测试，经过测试研究发现以下情况：

| jar 版本   | weblogic 版本 | 成功情况 |
| :--------- | :------------ | :------- |
| 12.1.3.0.0 | 12.1.3.0.0    | 成功     |
| 12.1.3.0.0 | 12.2.1.3.0    | 失败     |
| 12.1.3.0.0 | 12.2.1.4.0    | 失败     |
| 12.1.3.0.0 | 14.1.1.0.0    | 失败     |
| 12.2.1.3.0 | 12.1.3.0.0    | 失败     |
| 12.2.1.3.0 | 12.2.1.3.0    | 成功     |
| 12.2.1.3.0 | 12.2.1.4.0    | 成功     |
| 12.2.1.3.0 | 14.1.1.0.0    | 成功     |
| 12.2.1.4.0 | 12.1.3.0.0    | 失败     |
| 12.2.1.4.0 | 12.2.1.3.0    | 成功     |
| 12.2.1.4.0 | 12.2.1.4.0    | 成功     |
| 12.2.1.4.0 | 14.1.1.0.0    | 成功     |
| 14.1.1.0.0 | 12.1.3.0.0    | 失败     |
| 14.1.1.0.0 | 12.2.1.3.0    | 成功     |
| 14.1.1.0.0 | 12.2.1.4.0    | 成功     |
| 14.1.1.0.0 | 14.1.1.0.0    | 成功     |


## 2.4 通用修补建议

Oracle官方已经发布补丁，及时进行更新：https://www.oracle.com/security-alerts/cpujul2021.html

## 2.5 Weblogic 临时修补建议

1. 如果不依赖 T3协议进行 JVM通信，可禁用 T3协议。
2. 如果不依赖 IIOP协议进行 JVM通信，可禁用 IIOP协议。

# 0x03 参考

https://www.cnblogs.com/potatsoSec/p/15062094.html

https://mp.weixin.qq.com/s/LbMB-2Qyrh3Lrqc_vsKIdA



<br/>

<br/>
**[Goby 官网: https://gobysec.net/](https://gobysec.net/)** 

如果您有任何反馈建议，您可通过提交 issue 或是以下方式联系我们：

1. GitHub issue: [https://github.com/gobysec/Goby/issues](https://github.com/gobysec/Goby/issues)
2. 微信群：关注公众号“GobySec“，回复暗号”加群“ （社群优势：可第一时间了解Goby功能发布、活动等咨询）
3. Telegram Group: [http://t.me/gobies](http://t.me/gobies) (Group benefits: enjoy the version update 1 month in advance) 
4. 推特：[https://twitter.com/GobySec](https://twitter.com/GobySec)
